---
phase: 01-core-infrastructure-authentication
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - package.json
  - drizzle.config.ts
  - src/db/schema.ts
  - src/db/index.ts
autonomous: true
user_setup:
  - service: postgresql
    why: "Database for storing trips and user data"
    env_vars:
      - name: DATABASE_URL
        source: "PostgreSQL provider (Neon, Supabase, Railway, or local Docker)"
    dashboard_config:
      - task: "Create PostgreSQL database with PostGIS extension"
        location: "Your PostgreSQL provider dashboard or run: CREATE EXTENSION IF NOT EXISTS postgis;"

must_haves:
  truths:
    - "Database connection succeeds"
    - "Trips table exists with correct schema"
    - "Schema migrations can be applied"
  artifacts:
    - path: "src/db/schema.ts"
      provides: "Drizzle schema definitions"
      contains: "trips"
    - path: "src/db/index.ts"
      provides: "Database client instance"
      contains: "drizzle"
    - path: "drizzle.config.ts"
      provides: "Drizzle Kit configuration"
      contains: "defineConfig"
  key_links:
    - from: "src/db/index.ts"
      to: "src/db/schema.ts"
      via: "schema import"
      pattern: "import.*schema"
    - from: "drizzle.config.ts"
      to: "src/db/schema.ts"
      via: "schema path"
      pattern: "schema.*db/schema"
---

<objective>
Set up PostgreSQL database with Drizzle ORM, including the trips table schema with proper timezone handling.

Purpose: Establish the database layer for storing user trips. Uses timestamptz for proper timezone handling (from RESEARCH.md) and prepares for PostGIS spatial data in future phases.

Output: Working database connection with Drizzle ORM, trips table schema, and migration tooling ready.
</objective>

<execution_context>
@/Users/quentonschneider/.claude/get-shit-done/workflows/execute-plan.md
@/Users/quentonschneider/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-infrastructure-authentication/01-RESEARCH.md
@.planning/phases/01-core-infrastructure-authentication/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Drizzle ORM and PostgreSQL Driver</name>
  <files>
    package.json
  </files>
  <action>
Install Drizzle ORM, PostgreSQL driver, and Drizzle Kit for migrations:

```bash
npm install drizzle-orm pg dotenv
npm install -D drizzle-kit @types/pg tsx
```

Package purposes:
- drizzle-orm: Type-safe ORM with zero runtime overhead
- pg: PostgreSQL driver for Node.js
- dotenv: Load .env files (used by drizzle-kit)
- drizzle-kit: CLI for migrations and schema management
- @types/pg: TypeScript types for pg
- tsx: TypeScript execution for running migrations

Optionally for Vercel deployment (install now to avoid forgetting):
```bash
npm install @vercel/functions
```
  </action>
  <verify>
    # Verify all packages installed
    grep -q "drizzle-orm" package.json
    grep -q '"pg"' package.json
    grep -q "drizzle-kit" package.json
  </verify>
  <done>
    Drizzle ORM and PostgreSQL driver installed. Drizzle Kit available for migrations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Database Schema with Trips Table</name>
  <files>
    src/db/schema.ts
  </files>
  <action>
Create src/db/schema.ts with the trips table.

CRITICAL (from RESEARCH.md Pitfall 2): Use `timestamp('column', { withTimezone: true })` for ALL date/time columns. Never use `timestamp` without timezone - it causes DST bugs.

```typescript
// src/db/schema.ts
import {
  pgTable,
  uuid,
  text,
  timestamp,
} from 'drizzle-orm/pg-core';

// Trips table - stores user trip information
export const trips = pgTable('trips', {
  id: uuid('id').primaryKey().defaultRandom(),

  // Clerk user ID - links trip to authenticated user
  userId: text('user_id').notNull(),

  // Trip details
  name: text('name').notNull(),
  description: text('description'),

  // Trip date range - MUST use timestamptz (withTimezone: true)
  // This prevents DST bugs and ensures correct date handling
  startDate: timestamp('start_date', {
    withTimezone: true,
    mode: 'date',  // Returns JavaScript Date objects
  }).notNull(),

  endDate: timestamp('end_date', {
    withTimezone: true,
    mode: 'date',
  }).notNull(),

  // Audit timestamps
  createdAt: timestamp('created_at', {
    withTimezone: true,
  }).notNull().defaultNow(),

  updatedAt: timestamp('updated_at', {
    withTimezone: true,
  }).notNull().defaultNow(),
});

// Type exports for use in queries and components
export type Trip = typeof trips.$inferSelect;
export type NewTrip = typeof trips.$inferInsert;
```

Notes:
- userId stores Clerk user ID (string format like "user_2abc...")
- No foreign key to users table - Clerk manages users externally
- mode: 'date' returns JavaScript Date objects instead of strings
- Events table will be added in Phase 2 (Manual Input & Wishlist Building)
  </action>
  <verify>
    # Verify schema uses timestamptz
    grep -q "withTimezone: true" src/db/schema.ts

    # Verify trips table is exported
    grep -q "export const trips" src/db/schema.ts

    # Verify type exports
    grep -q "export type Trip" src/db/schema.ts
  </verify>
  <done>
    Trips table schema created with proper timezone handling (timestamptz), UUID primary key, Clerk user ID reference, and audit timestamps.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Database Client and Drizzle Config</name>
  <files>
    src/db/index.ts
    drizzle.config.ts
  </files>
  <action>
Create src/db/index.ts - the database client instance.

CRITICAL (from RESEARCH.md Pitfall 3): Use connection pooling. Never create a new pool per request - this exhausts connections in serverless.

```typescript
// src/db/index.ts
import { drizzle } from 'drizzle-orm/node-postgres';
import { Pool } from 'pg';
import * as schema from './schema';

// Check for Vercel environment to use proper connection handling
const isVercel = !!process.env.VERCEL;

// Create connection pool - reused across requests
// In serverless, this pool persists across warm invocations
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  max: 10,                      // Max connections in pool
  idleTimeoutMillis: 5000,      // Close idle connections after 5s
  connectionTimeoutMillis: 10000, // Connection timeout
});

// For Vercel, attach cleanup handler
// This ensures connections are properly released before function suspension
if (isVercel) {
  // Dynamic import to avoid issues in non-Vercel environments
  import('@vercel/functions').then(({ attachDatabasePool }) => {
    attachDatabasePool(pool);
  }).catch(() => {
    // @vercel/functions not available - likely local dev
  });
}

// Export the Drizzle database instance
export const db = drizzle({
  client: pool,
  schema,
});

// Re-export schema for convenience
export * from './schema';
```

Create drizzle.config.ts at project root:
```typescript
// drizzle.config.ts
import 'dotenv/config';
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  out: './drizzle',
  schema: './src/db/schema.ts',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
  // Verbose output during migrations
  verbose: true,
  // Strict mode - fail on warnings
  strict: true,
});
```

Add npm scripts to package.json for database operations:
```json
{
  "scripts": {
    "db:generate": "drizzle-kit generate",
    "db:migrate": "drizzle-kit migrate",
    "db:push": "drizzle-kit push",
    "db:studio": "drizzle-kit studio"
  }
}
```

Update package.json to add these scripts (merge with existing scripts).
  </action>
  <verify>
    # Verify db client exports drizzle instance
    grep -q "export const db" src/db/index.ts

    # Verify drizzle config exists
    test -f drizzle.config.ts && echo "drizzle.config.ts exists"

    # Verify config points to schema
    grep -q "db/schema" drizzle.config.ts
  </verify>
  <done>
    Database client configured with connection pooling and Vercel-aware cleanup. Drizzle Kit configured for migrations. npm scripts added for db:generate, db:push, db:migrate, and db:studio.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds (schema imports work)
2. src/db/schema.ts defines trips table with timestamptz columns
3. src/db/index.ts exports db instance with pooling
4. drizzle.config.ts configured for PostgreSQL
5. npm scripts for database operations in package.json

NOTE: Database operations (db:push, db:generate) require DATABASE_URL. User setup must provide connection string before migrations can run.
</verification>

<success_criteria>
- Drizzle ORM and pg driver installed
- Trips table schema with proper timestamptz columns
- Database client with connection pooling
- Drizzle Kit configured for migrations
- Type exports (Trip, NewTrip) available for use in queries
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure-authentication/01-03-SUMMARY.md`
</output>
