---
phase: 01-core-infrastructure-authentication
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - package.json
  - middleware.ts
  - src/app/layout.tsx
  - src/app/(auth)/sign-in/[[...sign-in]]/page.tsx
  - src/app/(auth)/sign-up/[[...sign-up]]/page.tsx
  - src/app/(dashboard)/layout.tsx
  - src/components/user-button.tsx
autonomous: true
user_setup:
  - service: clerk
    why: "Authentication provider"
    env_vars:
      - name: CLERK_SECRET_KEY
        source: "Clerk Dashboard -> API Keys -> Secret keys"
      - name: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
        source: "Clerk Dashboard -> API Keys -> Publishable key"
    dashboard_config:
      - task: "Create Clerk application"
        location: "https://dashboard.clerk.com -> Create application"
      - task: "Enable Email/Password authentication"
        location: "Clerk Dashboard -> User & Authentication -> Email, phone, username"

must_haves:
  truths:
    - "User can sign up with email and password"
    - "User can log in and session persists across browser refresh"
    - "User can log out from any page"
    - "Unauthenticated users are redirected to sign-in page when accessing /trips"
  artifacts:
    - path: "middleware.ts"
      provides: "Route protection with Clerk"
      contains: "clerkMiddleware"
    - path: "src/app/layout.tsx"
      provides: "ClerkProvider wrapper"
      contains: "ClerkProvider"
    - path: "src/app/(auth)/sign-in/[[...sign-in]]/page.tsx"
      provides: "Sign-in page"
      contains: "SignIn"
    - path: "src/app/(auth)/sign-up/[[...sign-up]]/page.tsx"
      provides: "Sign-up page"
      contains: "SignUp"
  key_links:
    - from: "middleware.ts"
      to: "protected routes"
      via: "createRouteMatcher"
      pattern: "isProtectedRoute.*trips"
    - from: "src/app/layout.tsx"
      to: "@clerk/nextjs"
      via: "ClerkProvider import"
      pattern: "ClerkProvider"
---

<objective>
Integrate Clerk authentication with sign-up, sign-in, logout, and route protection.

Purpose: Enable user authentication using Clerk's managed service. This covers AUTH-01, AUTH-02, AUTH-03 requirements. AUTH-04 (password reset) is handled automatically by Clerk.

Output: Working authentication flow where users can sign up, log in, stay logged in across refreshes, log out, and are redirected when accessing protected routes without authentication.
</objective>

<execution_context>
@/Users/quentonschneider/.claude/get-shit-done/workflows/execute-plan.md
@/Users/quentonschneider/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-infrastructure-authentication/01-RESEARCH.md
@.planning/phases/01-core-infrastructure-authentication/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Clerk and Configure Provider</name>
  <files>
    package.json
    src/app/layout.tsx
  </files>
  <action>
Install Clerk Next.js SDK:
```bash
npm install @clerk/nextjs
```

Update src/app/layout.tsx to wrap the app with ClerkProvider:
```typescript
import type { Metadata } from "next";
import { ClerkProvider } from "@clerk/nextjs";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Trip Coordinator",
  description: "AI-powered trip coordination and itinerary planning",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <ClerkProvider>
      <html lang="en">
        <body
          className={`${geistSans.variable} ${geistMono.variable} antialiased`}
        >
          {children}
        </body>
      </html>
    </ClerkProvider>
  );
}
```

CRITICAL (from RESEARCH.md Pitfall 4): ClerkProvider MUST wrap the entire app at the root layout level, otherwise auth hooks will fail with "Clerk can't detect usage of clerkMiddleware()" errors.
  </action>
  <verify>
    # Verify ClerkProvider is in layout.tsx
    grep -q "ClerkProvider" src/app/layout.tsx

    # Verify @clerk/nextjs is installed
    grep -q "@clerk/nextjs" package.json
  </verify>
  <done>
    Clerk SDK installed and ClerkProvider configured in root layout. App is ready for authentication components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Authentication Pages and Middleware</name>
  <files>
    middleware.ts
    src/app/(auth)/sign-in/[[...sign-in]]/page.tsx
    src/app/(auth)/sign-up/[[...sign-up]]/page.tsx
    src/app/(auth)/layout.tsx
  </files>
  <action>
Create middleware.ts at project root (NOT in src/) for route protection.

CRITICAL (from RESEARCH.md Pitfall 1): By default, clerkMiddleware() makes ALL routes public. You MUST explicitly protect routes with createRouteMatcher() and auth.protect().

```typescript
// middleware.ts
import { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server';

// Define which routes require authentication
const isProtectedRoute = createRouteMatcher([
  '/trips(.*)',
  '/api/trips(.*)',
]);

export default clerkMiddleware(async (auth, req) => {
  if (isProtectedRoute(req)) {
    await auth.protect();
  }
});

export const config = {
  matcher: [
    // Skip Next.js internals and static files
    '/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',
    // Always run for API routes
    '/(api|trpc)(.*)',
  ],
};
```

Create auth route group and pages:

src/app/(auth)/layout.tsx:
```typescript
export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      {children}
    </div>
  );
}
```

src/app/(auth)/sign-in/[[...sign-in]]/page.tsx:
```typescript
import { SignIn } from "@clerk/nextjs";

export default function SignInPage() {
  return <SignIn />;
}
```

src/app/(auth)/sign-up/[[...sign-up]]/page.tsx:
```typescript
import { SignUp } from "@clerk/nextjs";

export default function SignUpPage() {
  return <SignUp />;
}
```

Note: The [[...sign-in]] and [[...sign-up]] catch-all routes are required by Clerk to handle multi-step auth flows.
  </action>
  <verify>
    # Verify middleware exists at root
    test -f middleware.ts && echo "middleware.ts exists"

    # Verify protected routes are defined
    grep -q "isProtectedRoute" middleware.ts
    grep -q "/trips" middleware.ts

    # Verify auth pages exist
    test -f "src/app/(auth)/sign-in/[[...sign-in]]/page.tsx" && echo "sign-in page exists"
    test -f "src/app/(auth)/sign-up/[[...sign-up]]/page.tsx" && echo "sign-up page exists"
  </verify>
  <done>
    Clerk middleware configured with explicit route protection for /trips and /api/trips. Sign-in and sign-up pages created with Clerk components.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Dashboard Layout with User Button and Logout</name>
  <files>
    src/app/(dashboard)/layout.tsx
    src/app/(dashboard)/page.tsx
    src/app/(dashboard)/trips/page.tsx
    src/components/user-button.tsx
  </files>
  <action>
Create the dashboard route group for authenticated pages.

src/components/user-button.tsx - A wrapper for Clerk's UserButton with logout:
```typescript
"use client";

import { UserButton } from "@clerk/nextjs";

export function UserButtonWithMenu() {
  return (
    <UserButton
      afterSignOutUrl="/"
      appearance={{
        elements: {
          avatarBox: "h-10 w-10",
        },
      }}
    />
  );
}
```

src/app/(dashboard)/layout.tsx:
```typescript
import { auth } from "@clerk/nextjs/server";
import { redirect } from "next/navigation";
import { UserButtonWithMenu } from "@/components/user-button";

export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  // Defense-in-depth: Verify auth in layout (RESEARCH.md Pattern 1)
  // Note: This is secondary protection - middleware handles redirects
  const { userId } = await auth();

  if (!userId) {
    redirect("/sign-in");
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-white shadow-sm border-b">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <h1 className="text-xl font-semibold text-gray-900">
              Trip Coordinator
            </h1>
            <UserButtonWithMenu />
          </div>
        </div>
      </header>
      <main className="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        {children}
      </main>
    </div>
  );
}
```

src/app/(dashboard)/page.tsx - Dashboard home (redirects to trips):
```typescript
import { redirect } from "next/navigation";

export default function DashboardPage() {
  redirect("/trips");
}
```

src/app/(dashboard)/trips/page.tsx - Placeholder trips page:
```typescript
import { auth } from "@clerk/nextjs/server";
import { redirect } from "next/navigation";

export default async function TripsPage() {
  // Defense-in-depth auth check (RESEARCH.md Pattern 1)
  const { userId } = await auth();

  if (!userId) {
    redirect("/sign-in");
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-2xl font-bold text-gray-900">My Trips</h2>
        <button
          className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors"
          disabled
        >
          New Trip
        </button>
      </div>
      <div className="bg-white rounded-lg shadow p-6">
        <p className="text-gray-500 text-center py-8">
          No trips yet. Create your first trip to get started!
        </p>
      </div>
    </div>
  );
}
```

Update src/app/page.tsx to be a landing page with sign-in/sign-up links:
```typescript
import Link from "next/link";
import { auth } from "@clerk/nextjs/server";
import { redirect } from "next/navigation";

export default async function HomePage() {
  const { userId } = await auth();

  // If already logged in, redirect to trips
  if (userId) {
    redirect("/trips");
  }

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-b from-blue-50 to-white">
      <div className="text-center max-w-2xl px-4">
        <h1 className="text-4xl font-bold text-gray-900 mb-4">
          Trip Coordinator
        </h1>
        <p className="text-xl text-gray-600 mb-8">
          Upload your bookings, build a wishlist, and let AI create the perfect
          itinerary for your trip.
        </p>
        <div className="flex gap-4 justify-center">
          <Link
            href="/sign-in"
            className="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition-colors font-medium"
          >
            Sign In
          </Link>
          <Link
            href="/sign-up"
            className="bg-white text-blue-600 px-6 py-3 rounded-md border border-blue-600 hover:bg-blue-50 transition-colors font-medium"
          >
            Sign Up
          </Link>
        </div>
      </div>
    </div>
  );
}
```
  </action>
  <verify>
    # Verify dashboard layout has UserButton
    grep -q "UserButton" src/app/\\(dashboard\\)/layout.tsx

    # Verify defense-in-depth auth check
    grep -q "await auth()" src/app/\\(dashboard\\)/trips/page.tsx

    # Verify home page has sign-in/sign-up links
    grep -q "sign-in" src/app/page.tsx
    grep -q "sign-up" src/app/page.tsx
  </verify>
  <done>
    Dashboard layout with header and UserButton created. Trips placeholder page with auth check. Landing page with authentication links. Logout available via UserButton dropdown (AUTH-03).
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. middleware.ts exists at project root (not in src/)
3. ClerkProvider wraps the app in root layout
4. Sign-in and sign-up pages render Clerk components
5. Dashboard layout includes UserButton with logout
6. Protected routes (/trips) defined in middleware

NOTE: Full auth flow testing requires Clerk API keys. User setup (env vars) must be completed before auth can be verified end-to-end.
</verification>

<success_criteria>
- Clerk SDK installed and provider configured
- Sign-up page available at /sign-in
- Sign-in page available at /sign-up
- Middleware protects /trips and /api/trips routes
- UserButton provides logout functionality
- Defense-in-depth auth checks in Server Components
- Landing page redirects authenticated users to /trips
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure-authentication/01-02-SUMMARY.md`
</output>
